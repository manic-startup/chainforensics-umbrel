# ChainForensics - Umbrel App Docker Compose
# Privacy-focused Bitcoin blockchain analysis

services:
  # ===========================================
  # Core API Server
  # ===========================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - DEBUG=false
      - API_PORT=3000
      - DATABASE_URL=sqlite+aiosqlite:///./data/chainforensics.db
      # Bitcoin Core RPC - Umbrel internal network
      - BITCOIN_RPC_HOST=${APP_BITCOIN_NODE_IP}
      - BITCOIN_RPC_PORT=8332
      - BITCOIN_RPC_USER=${APP_BITCOIN_RPC_USER}
      - BITCOIN_RPC_PASS=${APP_BITCOIN_RPC_PASS}
      - BITCOIN_RPC_TIMEOUT=60
      # Fulcrum - Umbrel internal network
      - FULCRUM_HOST=${APP_FULCRUM_IP}
      - FULCRUM_PORT=50001
      # Analysis settings
      - MAX_TRACE_DEPTH=50
      - DEFAULT_TRACE_DEPTH=10
      - ENABLE_BACKGROUND_INDEXER=true
    volumes:
      - ${APP_DATA_DIR}/data:/app/data
    networks:
      default:
        ipv4_address: ${APP_CHAINFORENSICS_API_IP}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # Web Dashboard
  # ===========================================
  web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${APP_CHAINFORENSICS_WEB_PORT}:80"
    depends_on:
      - api
    networks:
      default:
        ipv4_address: ${APP_CHAINFORENSICS_WEB_IP}
    environment:
      - API_URL=http://${APP_CHAINFORENSICS_API_IP}:3000

networks:
  default:
    name: ${APP_NETWORK}
    external: true
