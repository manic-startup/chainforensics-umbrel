<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChainForensics - Blockchain Analysis Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #238636;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-yellow: #f0b429;
            --accent-cyan: #39c5cf;
            --border-color: #30363d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 1.5rem; font-weight: 600; color: var(--accent-blue); }
        .logo-icon { font-size: 2rem; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .status-badge { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-tertiary); border-radius: 20px; font-size: 0.875rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); }
        .status-dot.disconnected { background: var(--accent-red); }
        .main-container { display: grid; grid-template-columns: 340px 1fr; min-height: calc(100vh - 65px); }
        .sidebar { background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px; overflow-y: auto; overflow-x: visible; position: relative; }
        .sidebar-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); background: var(--bg-tertiary); border-radius: 8px; padding: 16px; border: 1px solid var(--border-color); }
        .sidebar-section:last-child { margin-bottom: 0; }
        .sidebar-title { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 12px; letter-spacing: 1px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .sidebar-title-icon { font-size: 1rem; }
        .sidebar-section.tx-analysis { border-left: 3px solid var(--accent-blue); }
        .sidebar-section.tx-analysis .sidebar-title { color: var(--accent-blue); }
        .sidebar-section.address-lookup { border-left: 3px solid var(--accent-orange); }
        .sidebar-section.address-lookup .sidebar-title { color: var(--accent-orange); }
        .sidebar-section.kyc-check { border-left: 3px solid var(--accent-cyan); }
        .sidebar-section.kyc-check .sidebar-title { color: var(--accent-cyan); }
        .sidebar-section.support { border-left: 3px solid var(--accent-yellow); }
        .sidebar-section.support .sidebar-title { color: var(--accent-yellow); }
        .subsection-divider { height: 1px; background: var(--border-color); margin: 16px 0; }
        .subsection-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 12px; letter-spacing: 0.5px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
        .input-group input, .input-group select { width: 100%; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; font-family: monospace; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--accent-blue); }
        .input-group small { display: block; font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #4c9aed; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-kyc { background: linear-gradient(135deg, var(--accent-cyan), #2596be); color: white; font-weight: 600; }
        .btn-kyc:hover { background: linear-gradient(135deg, #2dbdcc, #1e7a9c); }
        .btn-donate { background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow)); color: #000; font-weight: 600; }
        .btn-donate:hover { background: linear-gradient(135deg, #e09000, #f5c842); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Help tooltip styles */
        .help-icon { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 14px; 
            height: 14px; 
            background: var(--bg-tertiary); 
            border: 1px solid var(--border-color); 
            border-radius: 50%; 
            font-size: 9px; 
            color: var(--text-secondary); 
            cursor: help; 
            position: relative;
            flex-shrink: 0;
        }
        .help-icon:hover { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .help-icon .tooltip { 
            display: none; 
            position: fixed; 
            background: var(--bg-primary); 
            border: 1px solid var(--accent-blue); 
            border-radius: 6px; 
            padding: 10px 12px; 
            width: 280px; 
            font-size: 0.75rem; 
            color: var(--text-primary); 
            z-index: 9999; 
            font-weight: normal;
            text-transform: none;
            letter-spacing: normal;
            line-height: 1.4;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            pointer-events: none;
        }
        .help-icon:hover .tooltip { display: block; }
        .tooltip-title { font-weight: 600; color: var(--accent-blue); margin-bottom: 4px; display: block; }
        
        .content { padding: 24px; overflow-y: auto; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; }
        .stat-value { font-size: 1.4rem; font-weight: 600; color: var(--accent-blue); }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
        .tx-details { display: grid; gap: 12px; }
        .tx-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .tx-row:last-child { border-bottom: none; }
        .tx-label { color: var(--text-secondary); }
        .tx-value { font-family: monospace; word-break: break-all; }
        .tx-value.positive { color: var(--accent-green); }
        .tx-value.negative { color: var(--accent-red); }
        .cj-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .cj-badge.high { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .cj-badge.medium { background: rgba(210, 153, 34, 0.2); color: var(--accent-orange); }
        .cj-badge.low { background: rgba(35, 134, 54, 0.2); color: var(--accent-green); }
        .cj-badge.info { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }
        .io-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .io-table th, .io-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .io-table th { color: var(--text-secondary); font-weight: 500; }
        .io-table td.mono { font-family: monospace; font-size: 0.8rem; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-secondary); }
        .spinner { width: 24px; height: 24px; border: 2px solid var(--border-color); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .privacy-score { display: flex; align-items: center; gap: 20px; }
        .score-circle { width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 700; border: 4px solid; }
        .score-circle.excellent, .score-circle.good { border-color: var(--accent-green); color: var(--accent-green); }
        .score-circle.moderate { border-color: var(--accent-orange); color: var(--accent-orange); }
        .score-circle.poor, .score-circle.very_poor { border-color: var(--accent-red); color: var(--accent-red); }
        .score-details { flex: 1; }
        .score-rating { font-size: 1.25rem; font-weight: 600; text-transform: capitalize; }
        .score-summary { color: var(--text-secondary); margin: 8px 0; }
        .factor-list { list-style: none; margin-top: 16px; }
        .factor-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; font-size: 0.875rem; }
        .factor-impact { padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 0.75rem; }
        .factor-impact.positive { background: rgba(35, 134, 54, 0.2); color: var(--accent-green); }
        .factor-impact.negative { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; position: relative; text-align: center; }
        .modal-close { position: absolute; top: 12px; right: 12px; background: var(--bg-tertiary); border: none; color: var(--text-secondary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--accent-red); color: white; }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 16px; color: var(--accent-orange); }
        .qr-container { background: white; padding: 16px; border-radius: 8px; display: inline-block; margin-bottom: 16px; }
        .qr-container img { width: 200px; height: 200px; display: block; }
        .donation-address { background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-family: monospace; font-size: 0.75rem; word-break: break-all; margin-bottom: 12px; color: var(--accent-blue); }
        .copy-btn { background: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 6px; }
        .copy-btn:hover { background: #4c9aed; }
        .copy-btn.copied { background: var(--accent-green); }
        .modal-footer { margin-top: 16px; font-size: 0.875rem; color: var(--text-secondary); }
        .utxo-list { max-height: 300px; overflow-y: auto; }
        .utxo-item { display: flex; justify-content: space-between; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px; font-size: 0.875rem; }
        .utxo-txid { font-family: monospace; color: var(--accent-blue); }
        .utxo-value { font-weight: 600; }
        .dust-warning { background: rgba(248, 81, 73, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .dust-warning-title { color: var(--accent-red); font-weight: 600; margin-bottom: 8px; }
        .destination-card { background: var(--bg-tertiary); border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--accent-blue); }
        .destination-card.high-confidence { border-left-color: var(--accent-red); }
        .destination-card.medium-confidence { border-left-color: var(--accent-orange); }
        .destination-card.low-confidence { border-left-color: var(--accent-green); }
        .destination-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .destination-address { font-family: monospace; font-size: 0.85rem; color: var(--accent-blue); word-break: break-all; }
        .destination-confidence { font-weight: 700; font-size: 1.1rem; }
        .destination-confidence.high { color: var(--accent-red); }
        .destination-confidence.medium { color: var(--accent-orange); }
        .destination-confidence.low { color: var(--accent-green); }
        .destination-confidence.negligible { color: var(--text-secondary); }
        .destination-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 12px; margin-bottom: 12px; }
        .destination-stat { text-align: center; }
        .destination-stat-value { font-weight: 600; color: var(--text-primary); }
        .destination-stat-label { font-size: 0.75rem; color: var(--text-secondary); }
        .destination-reasoning { background: var(--bg-primary); border-radius: 4px; padding: 10px; font-size: 0.8rem; }
        .destination-reasoning li { color: var(--text-secondary); margin-left: 16px; margin-bottom: 4px; }
        .trail-status { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; margin-top: 4px; }
        .trail-status.cold { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .trail-status.dead_end { background: rgba(35, 134, 54, 0.2); color: var(--accent-green); }
        .trail-status.depth_limit { background: rgba(210, 153, 34, 0.2); color: var(--accent-orange); }
        .trail-status.lost { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }
        .timeline-event { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .timeline-event:last-child { border-bottom: none; }
        .timeline-date { width: 100px; color: var(--text-secondary); font-size: 0.875rem; }
        .timeline-bar-container { flex: 1; padding: 0 16px; }
        .timeline-bar { height: 24px; background: linear-gradient(90deg, var(--accent-green), #2ea043); border-radius: 4px; }
        .timeline-bar.coinjoin { background: linear-gradient(90deg, var(--accent-red), #da3633); }
        .timeline-bar.unspent { background: linear-gradient(90deg, var(--accent-blue), #4c9aed); }
        .timeline-details { width: 250px; text-align: right; }
        .timeline-value { font-weight: 600; color: var(--accent-blue); }
        .timeline-status { font-size: 0.75rem; color: var(--text-secondary); }
        .address-balance { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .balance-amount { font-size: 2rem; font-weight: 700; color: var(--accent-green); }
        .balance-label { color: var(--text-secondary); font-size: 0.875rem; }
        @media (max-width: 768px) { .main-container { grid-template-columns: 1fr; } .sidebar { border-right: none; border-bottom: 1px solid var(--border-color); } }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo"><span class="logo-icon">üîó</span><span>ChainForensics</span></div>
        <div class="header-right"><div class="status-badge"><div class="status-dot" id="status-dot"></div><span id="status-text">Connecting...</span></div></div>
    </header>
    <div class="main-container">
        <aside class="sidebar">
            <div class="sidebar-section tx-analysis">
                <div class="sidebar-title">
                    <span class="sidebar-title-icon">üîç</span>Transaction Analysis
                    <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">Transaction Analysis</span>Examine any Bitcoin transaction in detail. Enter a TXID to see inputs, outputs, fees, confirmations, and detect potential CoinJoin activity.</span></span>
                </div>
                <div class="input-group">
                    <label for="txid-input">Transaction ID
                        <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">Transaction ID (TXID)</span>The unique 64-character hexadecimal identifier for a Bitcoin transaction. You can find this in your wallet or on any block explorer.</span></span>
                    </label>
                    <input type="text" id="txid-input" placeholder="Enter txid..." />
                </div>
                <div class="input-group">
                    <label for="vout-input">Output Index (vout)
                        <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">Output Index (vout)</span>Every transaction can have multiple outputs (payments). The vout number identifies which specific output you want to analyze. Click "Analyze Transaction" first to see all outputs and their indices. Index starts at 0.</span></span>
                    </label>
                    <input type="number" id="vout-input" value="0" min="0" />
                </div>
                <button class="btn btn-primary" onclick="analyzeTransaction()">üîç Analyze Transaction</button>
                
                <div class="subsection-divider"></div>
                <div class="subsection-title">
                    <span>üîé</span> UTXO Tracing
                    <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">UTXO Tracing</span>Trace the flow of Bitcoin through the blockchain. Forward tracing shows where funds went after a transaction. Backward tracing reveals where the funds originally came from.</span></span>
                </div>
                <div class="input-group"><label for="trace-direction">Direction</label><select id="trace-direction"><option value="forward">Forward (where did it go?)</option><option value="backward">Backward (where did it come from?)</option></select></div>
                <div class="input-group">
                    <label for="trace-depth">Max Depth
                        <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">Max Depth</span>How many transaction "hops" to follow. Higher values find more connections but take longer and use more resources. Start with 5-10 for quick results.</span></span>
                    </label>
                    <input type="number" id="trace-depth" value="10" min="1" max="50" />
                </div>
                <button class="btn btn-primary" onclick="traceUTXO()">üîé Trace UTXO</button>
                
                <div class="subsection-divider"></div>
                <div class="subsection-title">
                    <span>‚ö°</span> Quick Actions
                    <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">Quick Actions</span><b>Detect CoinJoin:</b> Check if a transaction is a privacy-enhancing CoinJoin (Whirlpool, Wasabi, etc.).<br><br><b>Privacy Score:</b> Rate how private a specific UTXO is based on its history.<br><br><b>Timeline View:</b> Visualize the transaction flow over time.</span></span>
                </div>
                <button class="btn btn-secondary" onclick="detectCoinJoin()" style="margin-bottom: 8px;">üîÄ Detect CoinJoin</button>
                <button class="btn btn-secondary" onclick="calculatePrivacy()" style="margin-bottom: 8px;">üõ°Ô∏è Privacy Score</button>
                <button class="btn btn-secondary" onclick="showTimeline()">üìä Timeline View</button>
            </div>
            <div class="sidebar-section address-lookup">
                <div class="sidebar-title">
                    <span class="sidebar-title-icon">üìç</span>Address Lookup
                    <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">Address Lookup</span><b>Get Balance & UTXOs:</b> See current balance and unspent outputs for any address.<br><br><b>Check Dust Attack:</b> Detect suspicious tiny UTXOs that may be tracking attempts.<br><br><b>Validate Address:</b> Verify if an address format is valid and identify its type.</span></span>
                </div>
                <div class="input-group"><label for="address-input">Bitcoin Address</label><input type="text" id="address-input" placeholder="bc1q..." /></div>
                <button class="btn btn-secondary" onclick="getAddressInfo()" style="margin-bottom: 8px;">üí∞ Get Balance & UTXOs</button>
                <button class="btn btn-secondary" onclick="checkDustAttack()" style="margin-bottom: 8px;">üî¨ Check Dust Attack</button>
                <button class="btn btn-secondary" onclick="validateAddress()">‚úì Validate Address</button>
            </div>
            <div class="sidebar-section kyc-check">
                <div class="sidebar-title">
                    <span class="sidebar-title-icon">üïµÔ∏è</span>KYC Privacy Check
                    <span class="help-icon">?<span class="tooltip"><span class="tooltip-title">KYC Privacy Check</span>Check if your Bitcoin withdrawal from a KYC exchange (Coinbase, Kraken, etc.) can be traced to your current holdings. This simulates what an adversary who knows your exchange withdrawal could discover about where your funds are now.</span></span>
                </div>
                <div class="input-group"><label for="kyc-txid">Exchange Withdrawal TX</label><input type="text" id="kyc-txid" placeholder="Transaction ID from exchange..." /></div>
                <div class="input-group"><label for="kyc-address">Your Withdrawal Address</label><input type="text" id="kyc-address" placeholder="Address you withdrew to..." /></div>
                <div class="input-group"><label for="kyc-depth">Scan Depth</label><select id="kyc-depth"><option value="quick">Quick Scan (3 hops) - Low</option><option value="standard" selected>Standard (6 hops) - Medium</option><option value="deep">Deep Scan (10 hops) - High</option><option value="thorough">Thorough (15 hops) - Very High</option></select><small>‚ö†Ô∏è Higher depths take longer</small></div>
                <button class="btn btn-kyc" onclick="runKYCPrivacyCheck()">üïµÔ∏è Check My Privacy</button>
            </div>
            <div class="sidebar-section support">
                <div class="sidebar-title"><span class="sidebar-title-icon">üíù</span>Support</div>
                <button class="btn btn-donate" onclick="openDonationModal()">üç∫ Buy me a Drink</button>
            </div>
        </aside>
        <main class="content">
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card"><div class="stat-value" id="block-height">-</div><div class="stat-label">Block Height</div></div>
                <div class="stat-card"><div class="stat-value" id="chain-type">-</div><div class="stat-label">Network</div></div>
                <div class="stat-card"><div class="stat-value" id="sync-progress">-</div><div class="stat-label">Sync Progress</div></div>
                <div class="stat-card"><div class="stat-value" id="api-status">-</div><div class="stat-label">API Status</div></div>
                <div class="stat-card"><div class="stat-value" id="electrs-status">-</div><div class="stat-label">Electrs</div></div>
            </div>
            <div id="results-container">
                <div class="card"><div class="card-header"><div class="card-title">üìã Analysis Results</div></div><div class="card-body"><p style="color: var(--text-secondary); text-align: center; padding: 40px;">Enter a transaction ID and click "Analyze Transaction" to begin,<br>or use the <strong>KYC Privacy Check</strong> to see if your exchange withdrawal can be traced.</p></div></div>
            </div>
        </main>
    </div>
    <div class="modal-overlay" id="donation-modal">
        <div class="modal">
            <button class="modal-close" onclick="closeDonationModal()">√ó</button>
            <div class="modal-title">üç∫ Buy me a Drink</div>
            <div class="qr-container"><img src="qr-code.png" alt="Bitcoin Donation QR Code" id="qr-image" /></div>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">This is the way:</p>
            <div class="donation-address" id="donation-address">bc1qyouraddresshere</div>
            <button class="copy-btn" onclick="copyAddress()" id="copy-btn">üìã Copy Address</button>
            <div class="modal-footer">Thank you for your support! üôè</div>
        </div>
    </div>
    <script>
        const API_BASE = window.location.origin + '/api/v1';
        const DONATION_ADDRESS = 'bc1qyouraddresshere';
        let currentTxid = null;
        let currentTraceData = null;

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('donation-address').textContent = DONATION_ADDRESS;
            checkHealth();
            setInterval(checkHealth, 30000);
        });

        async function apiCall(endpoint, params) {
            params = params || {};
            const url = new URL(API_BASE + endpoint);
            Object.keys(params).forEach(function(key) { url.searchParams.append(key, params[key]); });
            const response = await fetch(url);
            if (!response.ok) { 
                const error = await response.json(); 
                throw new Error(error.detail || 'API Error'); 
            }
            return await response.json();
        }

        async function checkHealth() {
            try {
                const health = await apiCall('/health');
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                if (health.status === 'healthy') {
                    dot.classList.remove('disconnected');
                    text.textContent = 'Connected';
                } else {
                    dot.classList.add('disconnected');
                    text.textContent = 'Degraded';
                }
                if (health.components && health.components.bitcoin_core) {
                    const btc = health.components.bitcoin_core;
                    document.getElementById('block-height').textContent = btc.blocks ? btc.blocks.toLocaleString() : '-';
                    document.getElementById('chain-type').textContent = btc.chain || '-';
                    document.getElementById('sync-progress').textContent = btc.verification_progress ? (btc.verification_progress * 100).toFixed(2) + '%' : '-';
                }
                document.getElementById('api-status').textContent = 'Online';
                if (health.components && health.components.electrs) {
                    const electrs = health.components.electrs;
                    const el = document.getElementById('electrs-status');
                    if (electrs.status === 'connected') { el.textContent = 'Connected'; el.style.color = 'var(--accent-green)'; }
                    else if (electrs.status === 'not_configured') { el.textContent = 'Not configured'; el.style.color = 'var(--text-secondary)'; }
                    else { el.textContent = 'Offline'; el.style.color = 'var(--accent-orange)'; }
                }
            } catch (e) {
                document.getElementById('status-dot').classList.add('disconnected');
                document.getElementById('status-text').textContent = 'Disconnected';
                document.getElementById('api-status').textContent = 'Offline';
            }
        }

        function openDonationModal() { document.getElementById('donation-modal').classList.add('active'); }
        function closeDonationModal() { document.getElementById('donation-modal').classList.remove('active'); }
        function copyAddress() {
            navigator.clipboard.writeText(DONATION_ADDRESS).then(function() {
                const btn = document.getElementById('copy-btn');
                btn.classList.add('copied'); btn.innerHTML = '‚úì Copied!';
                setTimeout(function() { btn.classList.remove('copied'); btn.innerHTML = 'üìã Copy Address'; }, 2000);
            });
        }
        document.getElementById('donation-modal').addEventListener('click', function(e) { if (e.target.id === 'donation-modal') closeDonationModal(); });

        // Dynamic tooltip positioning
        document.querySelectorAll('.help-icon').forEach(function(icon) {
            icon.addEventListener('mouseenter', function(e) {
                var tooltip = this.querySelector('.tooltip');
                if (tooltip) {
                    var rect = this.getBoundingClientRect();
                    var tooltipWidth = 280;
                    var tooltipHeight = tooltip.offsetHeight || 100;
                    
                    // Position to the right of the icon
                    var left = rect.right + 8;
                    var top = rect.top + (rect.height / 2) - (tooltipHeight / 2);
                    
                    // If tooltip would go off right edge, position to the left
                    if (left + tooltipWidth > window.innerWidth - 20) {
                        left = rect.left - tooltipWidth - 8;
                    }
                    
                    // Keep tooltip within vertical bounds
                    if (top < 10) top = 10;
                    if (top + tooltipHeight > window.innerHeight - 10) {
                        top = window.innerHeight - tooltipHeight - 10;
                    }
                    
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                }
            });
        });

        function showLoading(msg) { 
            msg = msg || 'Loading...';
            document.getElementById('results-container').innerHTML = '<div class="card"><div class="card-body"><div class="loading"><div class="spinner"></div>' + msg + '</div></div></div>'; 
        }
        function showError(msg) { 
            document.getElementById('results-container').innerHTML = '<div class="card"><div class="card-body"><p style="color: var(--accent-red); text-align: center; padding: 40px;">‚ùå Error: ' + msg + '</p></div></div>'; 
        }

        async function runKYCPrivacyCheck() {
            const txid = document.getElementById('kyc-txid').value.trim();
            const address = document.getElementById('kyc-address').value.trim();
            const depth = document.getElementById('kyc-depth').value;
            if (!txid) { alert('Please enter the exchange withdrawal transaction ID'); return; }
            if (!address) { alert('Please enter the address you withdrew to'); return; }
            showLoading('Analyzing your privacy... This may take a moment.');
            try {
                const result = await apiCall('/kyc/trace', { exchange_txid: txid, destination_address: address, depth_preset: depth });
                renderKYCResult(result);
            } catch (e) { showError(e.message); }
        }

        function renderKYCResult(result) {
            const pc = result.privacy_rating;
            const dests = result.probable_destinations || [];
            const badgeClass = (pc === 'excellent' || pc === 'good') ? 'low' : (pc === 'moderate' ? 'medium' : 'high');
            
            let html = '<div class="card"><div class="card-header"><div class="card-title">üïµÔ∏è KYC Privacy Analysis</div>';
            html += '<span class="cj-badge ' + badgeClass + '">' + pc.toUpperCase() + ' PRIVACY</span></div><div class="card-body">';
            html += '<div class="privacy-score" style="margin-bottom: 24px;"><div class="score-circle ' + pc + '">' + result.overall_privacy_score.toFixed(0) + '</div>';
            html += '<div class="score-details"><div class="score-rating">' + pc.replace('_', ' ') + ' Privacy</div>';
            html += '<div class="score-summary">' + result.summary + '</div></div></div>';
            
            html += '<div class="stats-grid" style="margin-bottom: 24px;">';
            html += '<div class="stat-card"><div class="stat-value">' + (result.original_value_btc ? result.original_value_btc.toFixed(8) : '0') + '</div><div class="stat-label">Original BTC</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + result.destination_count + '</div><div class="stat-label">Destinations</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + result.high_confidence_destinations + '</div><div class="stat-label">High Confidence</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + result.coinjoins_encountered + '</div><div class="stat-label">CoinJoins</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + (result.untraceable_percent ? result.untraceable_percent.toFixed(1) : 0) + '%</div><div class="stat-label">Untraceable</div></div>';
            html += '</div>';
            
            if (!result.electrs_enabled) {
                html += '<div style="background: rgba(210, 153, 34, 0.1); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 12px; margin-bottom: 16px;"><span style="color: var(--accent-orange);">‚ö†Ô∏è Electrs Not Available</span> - Analysis may be incomplete.</div>';
            }
            if (result.warnings && result.warnings.length > 0) {
                html += '<div style="background: rgba(248, 81, 73, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 12px; margin-bottom: 16px;"><strong style="color: var(--accent-red);">‚ö†Ô∏è Warnings:</strong><ul style="margin: 8px 0 0 20px; color: var(--text-secondary);">';
                for (var i = 0; i < result.warnings.length; i++) { html += '<li>' + result.warnings[i] + '</li>'; }
                html += '</ul></div>';
            }
            html += '</div></div>';

            if (dests.length > 0) {
                html += '<div class="card"><div class="card-header"><div class="card-title">üìç Probable Current Holdings</div><span class="cj-badge info">' + dests.length + ' destination(s)</span></div><div class="card-body">';
                html += '<p style="color: var(--text-secondary); margin-bottom: 16px;">These are addresses where your funds likely ended up. Higher confidence = easier to trace.</p>';
                for (var j = 0; j < dests.length; j++) {
                    var d = dests[j];
                    var trailText = d.trail_status === 'cold' ? 'ü•∂ Trail Cold' : (d.trail_status === 'dead_end' ? 'üí∞ Unspent' : (d.trail_status === 'depth_limit' ? '‚è±Ô∏è Depth Limit' : '‚ùì Lost'));
                    var confColor = d.confidence_level === 'high' ? 'var(--accent-red)' : (d.confidence_level === 'medium' ? 'var(--accent-orange)' : 'var(--accent-green)');
                    html += '<div class="destination-card ' + d.confidence_level + '-confidence">';
                    html += '<div class="destination-header"><div><div class="destination-address">' + d.address + '</div>';
                    html += '<span class="trail-status ' + d.trail_status + '">' + trailText + '</span></div>';
                    html += '<div class="destination-confidence ' + d.confidence_level + '">' + d.confidence_percent + '</div></div>';
                    html += '<div class="destination-details">';
                    html += '<div class="destination-stat"><div class="destination-stat-value">' + (d.value_btc ? d.value_btc.toFixed(8) : '?') + '</div><div class="destination-stat-label">BTC</div></div>';
                    html += '<div class="destination-stat"><div class="destination-stat-value">' + d.path_length + '</div><div class="destination-stat-label">Hops</div></div>';
                    html += '<div class="destination-stat"><div class="destination-stat-value">' + d.coinjoins_passed + '</div><div class="destination-stat-label">CoinJoins</div></div>';
                    html += '<div class="destination-stat"><div class="destination-stat-value" style="color: ' + confColor + '">' + d.confidence_level.toUpperCase() + '</div><div class="destination-stat-label">Confidence</div></div>';
                    html += '</div>';
                    html += '<div class="destination-reasoning"><strong>Why:</strong><ul>';
                    for (var k = 0; k < d.reasoning.length; k++) { html += '<li>' + d.reasoning[k] + '</li>'; }
                    html += '</ul></div></div>';
                }
                html += '</div></div>';
            }
            
            if (result.recommendations && result.recommendations.length > 0) {
                html += '<div class="card"><div class="card-header"><div class="card-title">üí° Recommendations</div></div><div class="card-body"><ul class="factor-list">';
                for (var m = 0; m < result.recommendations.length; m++) {
                    html += '<li class="factor-item"><span class="factor-impact positive">TIP</span>' + result.recommendations[m] + '</li>';
                }
                html += '</ul></div></div>';
            }
            
            html += '<div class="card"><div class="card-header"><div class="card-title">‚ÑπÔ∏è Analysis Details</div></div><div class="card-body"><div class="tx-details">';
            html += '<div class="tx-row"><span class="tx-label">Exchange TX</span><span class="tx-value">' + result.exchange_txid + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Withdrawal Address</span><span class="tx-value">' + result.destination_address + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Scan Depth</span><span class="tx-value">' + result.trace_depth + ' hops</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Time</span><span class="tx-value">' + result.execution_time_ms + 'ms</span></div>';
            html += '</div></div></div>';
            
            document.getElementById('results-container').innerHTML = html;
        }

        async function analyzeTransaction() {
            const txid = document.getElementById('txid-input').value.trim();
            if (!txid) { alert('Please enter a transaction ID'); return; }
            currentTxid = txid; 
            showLoading();
            try { 
                const tx = await apiCall('/transactions/' + txid, { resolve_inputs: true }); 
                renderTx(tx); 
            } catch (e) { showError(e.message); }
        }

        function renderTx(tx) {
            let html = '<div class="card"><div class="card-header"><div class="card-title">üìã Transaction Details</div>';
            if (tx.is_coinbase) html += '<span class="cj-badge medium">‚õèÔ∏è Coinbase</span>';
            html += '</div><div class="card-body"><div class="tx-details">';
            html += '<div class="tx-row"><span class="tx-label">TXID</span><span class="tx-value">' + tx.txid + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Block Height</span><span class="tx-value">' + (tx.block_height ? tx.block_height.toLocaleString() : 'Unconfirmed') + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Confirmations</span><span class="tx-value">' + (tx.confirmations ? tx.confirmations.toLocaleString() : '0') + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Size</span><span class="tx-value">' + tx.vsize + ' vB (' + tx.size + ' bytes)</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Fee</span><span class="tx-value">' + (tx.fee_sats ? tx.fee_sats.toLocaleString() + ' sats' : 'N/A') + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Total Output</span><span class="tx-value positive">' + (tx.total_output_btc ? tx.total_output_btc.toFixed(8) : '0') + ' BTC</span></div>';
            html += '</div></div></div>';
            
            html += '<div class="card"><div class="card-header"><div class="card-title">üì• Inputs (' + tx.input_count + ')</div></div><div class="card-body"><table class="io-table"><thead><tr><th>#</th><th>Previous TX</th><th>Address</th><th>Value</th></tr></thead><tbody>';
            for (var i = 0; i < tx.inputs.length; i++) {
                var inp = tx.inputs[i];
                html += '<tr><td>' + i + '</td><td class="mono">' + (inp.txid ? inp.txid.substring(0, 16) + '...' : 'Coinbase') + '</td>';
                html += '<td class="mono">' + (inp.address || '-') + '</td><td>' + (inp.value ? inp.value.toFixed(8) + ' BTC' : '-') + '</td></tr>';
            }
            html += '</tbody></table></div></div>';
            
            html += '<div class="card"><div class="card-header"><div class="card-title">üì§ Outputs (' + tx.output_count + ')</div></div><div class="card-body"><table class="io-table"><thead><tr><th>#</th><th>Address</th><th>Type</th><th>Value</th></tr></thead><tbody>';
            for (var j = 0; j < tx.outputs.length; j++) {
                var out = tx.outputs[j];
                html += '<tr><td>' + out.n + '</td><td class="mono">' + (out.address || 'OP_RETURN') + '</td>';
                html += '<td>' + out.type + '</td><td>' + out.value_btc.toFixed(8) + ' BTC</td></tr>';
            }
            html += '</tbody></table></div></div>';
            
            document.getElementById('results-container').innerHTML = html;
        }

        async function traceUTXO() {
            const txid = document.getElementById('txid-input').value.trim();
            if (!txid) { alert('Please enter a transaction ID'); return; }
            const dir = document.getElementById('trace-direction').value;
            const depth = document.getElementById('trace-depth').value;
            const vout = document.getElementById('vout-input').value;
            showLoading();
            try {
                var result;
                if (dir === 'forward') {
                    result = await apiCall('/analysis/trace/forward', { txid: txid, vout: vout, max_depth: depth });
                } else {
                    result = await apiCall('/analysis/trace/backward', { txid: txid, max_depth: depth });
                }
                currentTraceData = result;
                renderTrace(result, dir);
            } catch (e) { showError(e.message); }
        }

        function renderTrace(result, dir) {
            const s = result.summary || {};
            let html = '<div class="stats-grid">';
            html += '<div class="stat-card"><div class="stat-value">' + (result.nodes ? result.nodes.length : 0) + '</div><div class="stat-label">Transactions</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + (s.unspent_count || 0) + '</div><div class="stat-label">Unspent</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + (s.coinjoin_count || 0) + '</div><div class="stat-label">CoinJoins</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + result.execution_time_ms + 'ms</div><div class="stat-label">Time</div></div>';
            html += '</div>';
            
            if (result.electrs_enabled) {
                html += '<div style="background: rgba(35, 134, 54, 0.1); border: 1px solid var(--accent-green); border-radius: 8px; padding: 12px; margin-bottom: 16px;"><span style="color: var(--accent-green);">‚úì Electrs Enabled</span></div>';
            } else {
                html += '<div style="background: rgba(210, 153, 34, 0.1); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 12px; margin-bottom: 16px;"><span style="color: var(--accent-orange);">‚ö† Electrs Not Available</span></div>';
            }
            
            html += '<div class="card"><div class="card-header"><div class="card-title">üîé Trace Results (' + dir + ')</div></div><div class="card-body">';
            if (result.nodes && result.nodes.length > 0) {
                html += '<table class="io-table"><thead><tr><th>Depth</th><th>TXID</th><th>Value</th><th>Status</th><th>CoinJoin</th></tr></thead><tbody>';
                var nodes = result.nodes.slice(0, 50);
                for (var i = 0; i < nodes.length; i++) {
                    var n = nodes[i];
                    var statusIcon = n.status === 'unspent' ? 'üí∞' : (n.status === 'coinbase' ? '‚õèÔ∏è' : 'üì§');
                    var cjBadge;
                    if (n.coinjoin_score > 0.7) {
                        cjBadge = '<span class="cj-badge high">üîÄ ' + (n.coinjoin_score * 100).toFixed(0) + '%</span>';
                    } else if (n.coinjoin_score > 0.3) {
                        cjBadge = '<span class="cj-badge medium">' + (n.coinjoin_score * 100).toFixed(0) + '%</span>';
                    } else {
                        cjBadge = '<span class="cj-badge low">No</span>';
                    }
                    html += '<tr><td>' + n.depth + '</td><td class="mono">' + n.txid.substring(0, 16) + '...</td>';
                    html += '<td>' + (n.value_btc ? n.value_btc.toFixed(8) : '?') + ' BTC</td><td>' + statusIcon + '</td><td>' + cjBadge + '</td></tr>';
                }
                html += '</tbody></table>';
                if (result.nodes.length > 50) {
                    html += '<p style="margin-top: 16px; color: var(--text-secondary);">Showing 50 of ' + result.nodes.length + '</p>';
                }
            } else {
                html += '<p style="color: var(--text-secondary);">No results</p>';
            }
            html += '</div></div>';
            
            document.getElementById('results-container').innerHTML = html;
        }

        async function detectCoinJoin() {
            const txid = document.getElementById('txid-input').value.trim();
            if (!txid) { alert('Please enter a transaction ID'); return; }
            showLoading();
            try { 
                const r = await apiCall('/analysis/coinjoin/' + txid); 
                renderCJ(r); 
            } catch (e) { showError(e.message); }
        }

        function renderCJ(r) {
            const bc = r.score > 0.7 ? 'high' : (r.score > 0.3 ? 'medium' : 'low');
            const sc = bc === 'high' ? 'poor' : (bc === 'medium' ? 'moderate' : 'good');
            let html = '<div class="card"><div class="card-header"><div class="card-title">üîÄ CoinJoin Analysis</div>';
            html += '<span class="cj-badge ' + bc + '">' + (r.is_coinjoin ? 'CoinJoin Detected' : 'Not CoinJoin') + '</span></div><div class="card-body">';
            html += '<div class="privacy-score"><div class="score-circle ' + sc + '">' + (r.score * 100).toFixed(0) + '%</div>';
            html += '<div class="score-details"><div class="score-rating">' + (r.protocol || 'No CoinJoin') + '</div>';
            html += '<div class="score-summary">Confidence: ' + (r.confidence * 100).toFixed(0) + '%</div></div></div>';
            html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">Stats</h3><div class="tx-details">';
            html += '<div class="tx-row"><span class="tx-label">Inputs</span><span class="tx-value">' + (r.transaction_stats ? r.transaction_stats.input_count : 'N/A') + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Outputs</span><span class="tx-value">' + (r.transaction_stats ? r.transaction_stats.output_count : 'N/A') + '</span></div>';
            html += '</div>';
            if (r.heuristics_matched && r.heuristics_matched.length > 0) {
                html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">‚úì Matched</h3><ul class="factor-list">';
                for (var i = 0; i < r.heuristics_matched.length; i++) {
                    html += '<li class="factor-item"><span class="factor-impact positive">‚úì</span>' + r.heuristics_matched[i] + '</li>';
                }
                html += '</ul>';
            }
            html += '</div></div>';
            document.getElementById('results-container').innerHTML = html;
        }

        async function calculatePrivacy() {
            const txid = document.getElementById('txid-input').value.trim();
            const vout = document.getElementById('vout-input').value;
            if (!txid) { alert('Please enter a transaction ID'); return; }
            showLoading();
            try { 
                const r = await apiCall('/analysis/privacy-score', { txid: txid, vout: vout }); 
                renderPrivacy(r); 
            } catch (e) { showError(e.message); }
        }

        function renderPrivacy(r) {
            const sc = r.rating === 'good' ? 'good' : (r.rating === 'moderate' ? 'moderate' : 'poor');
            let html = '<div class="card"><div class="card-header"><div class="card-title">üõ°Ô∏è Privacy Score</div></div><div class="card-body">';
            html += '<div class="privacy-score"><div class="score-circle ' + sc + '">' + r.score + '</div>';
            html += '<div class="score-details"><div class="score-rating">' + r.rating + ' Privacy</div><div class="score-summary">' + r.summary + '</div></div></div>';
            if (r.factors && r.factors.length > 0) {
                html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">Factors</h3><ul class="factor-list">';
                for (var i = 0; i < r.factors.length; i++) {
                    var impactClass = r.factors[i].impact.charAt(0) === '+' ? 'positive' : 'negative';
                    html += '<li class="factor-item"><span class="factor-impact ' + impactClass + '">' + r.factors[i].impact + '</span>' + r.factors[i].description + '</li>';
                }
                html += '</ul>';
            }
            if (r.recommendations && r.recommendations.length > 0) {
                html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">üí° Recommendations</h3><ul style="list-style: disc; margin-left: 20px; color: var(--text-secondary);">';
                for (var j = 0; j < r.recommendations.length; j++) {
                    html += '<li style="padding: 4px 0;">' + r.recommendations[j] + '</li>';
                }
                html += '</ul>';
            }
            html += '</div></div>';
            document.getElementById('results-container').innerHTML = html;
        }

        async function showTimeline() {
            const txid = document.getElementById('txid-input').value.trim();
            if (!txid) { alert('Please enter a transaction ID'); return; }
            const dir = document.getElementById('trace-direction').value;
            const depth = document.getElementById('trace-depth').value;
            const vout = document.getElementById('vout-input').value;
            showLoading();
            try { 
                const r = await apiCall('/visualizations/timeline/json', { txid: txid, vout: vout, direction: dir, max_depth: depth }); 
                renderTimeline(r); 
            } catch (e) { showError(e.message); }
        }

        function renderTimeline(r) {
            const events = r.events || [];
            if (events.length === 0) { 
                document.getElementById('results-container').innerHTML = '<div class="card"><div class="card-body"><p style="color: var(--text-secondary); text-align: center; padding: 40px;">No timeline events</p></div></div>'; 
                return; 
            }
            var maxV = 0;
            for (var i = 0; i < events.length; i++) { if (events[i].value_btc > maxV) maxV = events[i].value_btc; }
            if (maxV === 0) maxV = 1;
            
            let html = '<div class="card"><div class="card-header"><div class="card-title">üìä Timeline</div></div><div class="card-body">';
            html += '<div class="stats-grid" style="margin-bottom: 24px;">';
            html += '<div class="stat-card"><div class="stat-value">' + events.length + '</div><div class="stat-label">Events</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + (r.coinjoin_events || 0) + '</div><div class="stat-label">CoinJoins</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + (r.total_value_btc ? r.total_value_btc.toFixed(4) : '0') + '</div><div class="stat-label">Total BTC</div></div>';
            html += '</div><div style="overflow-x: auto;">';
            
            for (var j = 0; j < events.length; j++) {
                var e = events[j];
                var bw = Math.max(5, (e.value_btc / maxV) * 100);
                var bc = e.coinjoin_score > 0.5 ? 'coinjoin' : (e.event_type === 'receive' ? 'unspent' : '');
                var icon = e.event_type === 'coinjoin' ? 'üîÄ' : (e.event_type === 'mining' ? '‚õèÔ∏è' : (e.event_type === 'receive' ? 'üí∞' : 'üì§'));
                var dateStr = e.timestamp ? new Date(e.timestamp).toLocaleDateString() : 'Unknown';
                html += '<div class="timeline-event"><div class="timeline-date">' + dateStr + '</div>';
                html += '<div class="timeline-bar-container"><div class="timeline-bar ' + bc + '" style="width: ' + bw + '%"></div></div>';
                html += '<div class="timeline-details"><div class="timeline-value">' + icon + ' ' + (e.value_btc ? e.value_btc.toFixed(8) : '?') + ' BTC</div>';
                html += '<div class="timeline-status">' + e.description + '</div></div></div>';
            }
            html += '</div></div></div>';
            document.getElementById('results-container').innerHTML = html;
        }

        async function validateAddress() {
            const addr = document.getElementById('address-input').value.trim();
            if (!addr) { alert('Please enter a Bitcoin address'); return; }
            showLoading();
            try { 
                const r = await apiCall('/addresses/' + addr + '/validate'); 
                renderAddrVal(r); 
            } catch (e) { showError(e.message); }
        }

        function renderAddrVal(r) {
            let html = '<div class="card"><div class="card-header"><div class="card-title">üîç Address Validation</div>';
            html += '<span class="cj-badge ' + (r.is_valid ? 'low' : 'high') + '">' + (r.is_valid ? '‚úì Valid' : '‚úó Invalid') + '</span></div><div class="card-body"><div class="tx-details">';
            html += '<div class="tx-row"><span class="tx-label">Address</span><span class="tx-value">' + r.address + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Type</span><span class="tx-value">' + r.type + '</span></div>';
            html += '<div class="tx-row"><span class="tx-label">Network</span><span class="tx-value">' + r.network + '</span></div>';
            if (r.is_witness !== undefined) {
                html += '<div class="tx-row"><span class="tx-label">SegWit</span><span class="tx-value">' + (r.is_witness ? 'Yes' : 'No') + '</span></div>';
            }
            html += '</div></div></div>';
            document.getElementById('results-container').innerHTML = html;
        }

        async function getAddressInfo() {
            const addr = document.getElementById('address-input').value.trim();
            if (!addr) { alert('Please enter a Bitcoin address'); return; }
            showLoading();
            try { 
                const r = await apiCall('/addresses/' + addr + '/info'); 
                renderAddrInfo(r); 
            } catch (e) { showError(e.message); }
        }

        function renderAddrInfo(r) {
            const bal = r.balance || {};
            const utxos = r.utxos || [];
            const txs = r.transactions || [];
            let html = '<div class="card"><div class="card-header"><div class="card-title">üí∞ Address Info</div>';
            html += '<span class="cj-badge ' + (r.electrs_status === 'connected' ? 'low' : 'medium') + '">Electrs: ' + r.electrs_status + '</span></div><div class="card-body">';
            if (r.balance) {
                html += '<div class="address-balance"><div><div class="balance-amount">' + (bal.total_btc ? bal.total_btc.toFixed(8) : '0') + ' BTC</div>';
                html += '<div class="balance-label">Total Balance</div></div>';
                html += '<div style="margin-left: 40px;"><div style="color: var(--accent-green);">‚úì ' + (bal.confirmed_btc ? bal.confirmed_btc.toFixed(8) : '0') + ' confirmed</div>';
                html += '<div style="color: var(--accent-orange);">‚è≥ ' + (bal.unconfirmed_btc ? bal.unconfirmed_btc.toFixed(8) : '0') + ' unconfirmed</div></div></div>';
                html += '<div class="stats-grid" style="margin-bottom: 24px;">';
                html += '<div class="stat-card"><div class="stat-value">' + (r.transaction_count || 0) + '</div><div class="stat-label">Transactions</div></div>';
                html += '<div class="stat-card"><div class="stat-value">' + (r.utxo_count || 0) + '</div><div class="stat-label">UTXOs</div></div>';
                html += '<div class="stat-card"><div class="stat-value">' + (r.first_seen_height || '-') + '</div><div class="stat-label">First Seen</div></div>';
                html += '<div class="stat-card"><div class="stat-value">' + (r.last_seen_height || '-') + '</div><div class="stat-label">Last Seen</div></div>';
                html += '</div>';
            } else {
                html += '<p style="color: var(--text-secondary);">Electrs not available.</p>';
            }
            if (utxos.length > 0) {
                html += '<h3 style="margin-bottom: 12px;">UTXOs (' + utxos.length + ')</h3><div class="utxo-list">';
                var showUtxos = utxos.slice(0, 20);
                for (var i = 0; i < showUtxos.length; i++) {
                    var u = showUtxos[i];
                    html += '<div class="utxo-item"><div><div class="utxo-txid">' + u.txid.substring(0, 16) + '...#' + u.vout + '</div>';
                    html += '<div style="font-size: 0.75rem; color: var(--text-secondary);">' + (u.is_confirmed ? 'Block ' + u.height : 'Unconfirmed') + '</div></div>';
                    html += '<div class="utxo-value">' + u.value_btc.toFixed(8) + ' BTC</div></div>';
                }
                if (utxos.length > 20) {
                    html += '<p style="text-align: center; color: var(--text-secondary);">...and ' + (utxos.length - 20) + ' more</p>';
                }
                html += '</div>';
            }
            if (txs.length > 0) {
                html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">Recent Transactions</h3>';
                html += '<table class="io-table"><thead><tr><th>TXID</th><th>Height</th><th>Status</th></tr></thead><tbody>';
                var showTxs = txs.slice(0, 10);
                for (var j = 0; j < showTxs.length; j++) {
                    var t = showTxs[j];
                    html += '<tr><td class="mono">' + t.txid.substring(0, 20) + '...</td>';
                    html += '<td>' + (t.height || 'Mempool') + '</td><td>' + (t.is_confirmed ? '‚úì' : '‚è≥') + '</td></tr>';
                }
                html += '</tbody></table>';
            }
            html += '</div></div>';
            document.getElementById('results-container').innerHTML = html;
        }

        async function checkDustAttack() {
            const addr = document.getElementById('address-input').value.trim();
            if (!addr) { alert('Please enter a Bitcoin address'); return; }
            showLoading();
            try { 
                const r = await apiCall('/addresses/' + addr + '/dust-check'); 
                renderDust(r); 
            } catch (e) { showError(e.message); }
        }

        function renderDust(r) {
            let html = '<div class="card"><div class="card-header"><div class="card-title">üî¨ Dust Attack Check</div></div><div class="card-body">';
            if (r.suspicious_count > 0) {
                html += '<div class="dust-warning"><div class="dust-warning-title">‚ö†Ô∏è Warning: ' + r.suspicious_count + ' Suspicious UTXO(s)</div>';
                html += '<p>' + r.recommendation + '</p></div>';
            } else {
                html += '<div style="background: rgba(35, 134, 54, 0.1); border: 1px solid var(--accent-green); border-radius: 8px; padding: 16px; margin-bottom: 16px;">';
                html += '<div style="color: var(--accent-green); font-weight: 600;">‚úì No Dust Attack Detected</div>';
                html += '<p style="color: var(--text-secondary); margin-top: 8px;">' + r.recommendation + '</p></div>';
            }
            html += '<div class="stats-grid">';
            html += '<div class="stat-card"><div class="stat-value">' + r.total_utxos + '</div><div class="stat-label">Total UTXOs</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + r.dust_utxos_count + '</div><div class="stat-label">Dust UTXOs</div></div>';
            html += '<div class="stat-card"><div class="stat-value">' + r.total_dust_value_sats + '</div><div class="stat-label">Total Dust (sats)</div></div>';
            html += '</div>';
            if (r.suspicious_utxos && r.suspicious_utxos.length > 0) {
                html += '<h3 style="margin-top: 24px; margin-bottom: 12px;">‚ö†Ô∏è Suspicious</h3><div class="utxo-list">';
                for (var i = 0; i < r.suspicious_utxos.length; i++) {
                    var u = r.suspicious_utxos[i];
                    html += '<div class="utxo-item" style="border-left: 3px solid var(--accent-red);"><div>';
                    html += '<div class="utxo-txid">' + u.txid.substring(0, 16) + '...#' + u.vout + '</div>';
                    html += '<div style="font-size: 0.75rem; color: var(--accent-red);">' + u.warning + '</div></div>';
                    html += '<div class="utxo-value" style="color: var(--accent-red);">' + u.value_sats + ' sats</div></div>';
                }
                html += '</div><p style="margin-top: 16px; color: var(--accent-orange); font-size: 0.875rem;">üí° Do NOT consolidate these with your other coins!</p>';
            }
            html += '</div></div>';
            document.getElementById('results-container').innerHTML = html;
        }
    </script>
</body>
</html>