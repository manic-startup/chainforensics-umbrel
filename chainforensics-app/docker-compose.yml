# ChainForensics Umbrel Docker Compose Configuration
# Privacy-focused blockchain analysis platform for Umbrel

services:
  # ===========================================
  # Umbrel App Proxy (Entry Point)
  # ===========================================
  app_proxy:
    image: getumbrel/app-proxy:latest
    environment:
      APP_HOST: chainforensics-web
      APP_PORT: 80
    restart: unless-stopped
    networks:
      default:
        ipv4_address: $APP_CHAINFORENSICS_IP

  # ===========================================
  # Core API Server
  # ===========================================
  chainforensics-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    restart: unless-stopped
    environment:
      - DEBUG=false
      - API_PORT=3000
      - DATABASE_URL=sqlite+aiosqlite:///./data/chainforensics.db
      # Bitcoin Core RPC - Umbrel integration
      - BITCOIN_RPC_HOST=$APP_BITCOIN_IP
      - BITCOIN_RPC_PORT=$APP_BITCOIN_RPC_PORT
      - BITCOIN_RPC_USER=$APP_BITCOIN_RPC_USER
      - BITCOIN_RPC_PASS=$APP_BITCOIN_RPC_PASS
      - BITCOIN_RPC_TIMEOUT=60
      # Optional Fulcrum (if installed on Umbrel)
      - FULCRUM_HOST=$APP_FULCRUM_IP
      - FULCRUM_PORT=50001
      # Analysis settings
      - MAX_TRACE_DEPTH=50
      - DEFAULT_TRACE_DEPTH=10
      - ENABLE_BACKGROUND_INDEXER=true
    volumes:
      - ${APP_DATA_DIR}/data:/app/data
    networks:
      default:
        ipv4_address: $APP_CHAINFORENSICS_API_IP
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # Web Dashboard
  # ===========================================
  chainforensics-web:
    build:
      context: .
      dockerfile: Dockerfile.web
    restart: unless-stopped
    depends_on:
      - chainforensics-api
    networks:
      default:
        ipv4_address: $APP_CHAINFORENSICS_WEB_IP
    environment:
      - API_URL=http://chainforensics-api:3000
